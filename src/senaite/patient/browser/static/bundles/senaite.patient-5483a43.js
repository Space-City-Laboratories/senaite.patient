!function(e){var t={};function r(i){if(t[i])return t[i].exports;var n=t[i]={i:i,l:!1,exports:{}};return e[i].call(n.exports,n,n.exports,r),n.l=!0,n.exports}r.m=e,r.c=t,r.d=function(e,t,i){r.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:i})},r.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.t=function(e,t){if(1&t&&(e=r(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var i=Object.create(null);if(r.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var n in e)r.d(i,n,function(t){return e[t]}.bind(null,n));return i},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p="/++plone++senaite.patient.static/bundles",r(r.s=1)}([function(e,t,r){"use strict";(function(e){var r,i=function(e,t){return function(){return e.apply(t,arguments)}};r=function(){function t(){return this.debug=i(this.debug,this),this.get_portal_url=i(this.get_portal_url,this),this.ajax_submit=i(this.ajax_submit,this),this.render_template=i(this.render_template,this),this.template_dialog=i(this.template_dialog,this),this.search_mrn=i(this.search_mrn,this),this.get_subfield=i(this.get_subfield,this),this.format_date=i(this.format_date,this),this.set_sibling_value=i(this.set_sibling_value,this),this.get_sibling=i(this.get_sibling,this),this.get_field_name=i(this.get_field_name,this),this.get_input_element=i(this.get_input_element,this),this.get_autogenerated_id=i(this.get_autogenerated_id,this),this.get_current_id=i(this.get_current_id,this),this.set_current_id=i(this.set_current_id,this),this.set_temporary=i(this.set_temporary,this),this.on_value_change=i(this.on_value_change,this),this.on_temporary_change=i(this.on_temporary_change,this),this.bind_event_handler=i(this.bind_event_handler,this),this.reset_value=i(this.reset_value,this),this.reset_values=i(this.reset_values,this),console.debug("TemporaryIdentifierWidget::load"),this.auto_wildcard="-- autogenerated --",this.is_add_sample_form=document.body.classList.contains("template-ar_add"),this.is_add_sample_form&&this.reset_values(),this.bind_event_handler(),this}return t.prototype.reset_values=function(){var e,t,r,i,n,a,u,o,s,l,d,_;for(this.debug("°°° TemporaryIdentifierWidget::reset_values"),_=".TemporaryIdentifier.temporary-id input[id$='_value']",t=0,n=(o=document.querySelectorAll(_)).length;t<n;t++)e=o[t],this.reset_value(e,this.auto_wildcard);for(_=".TemporaryIdentifier.temporary-id input[name*='.value:']",r=0,a=(s=document.querySelectorAll(_)).length;r<a;r++)e=s[r],this.reset_value(e,this.auto_wildcard);for(_=".TemporaryIdentifier input[name*='.value_auto:']",d=[],i=0,u=(l=document.querySelectorAll(_)).length;i<u;i++)e=l[i],d.push(this.reset_value(e));return d},t.prototype.reset_value=function(e,t){return null==t&&(t=""),this.debug("°°° TemporaryIdentifierWidget::reset_value:el="+(e.id||e.name)+",value='"+t+"'"),e.value=t},t.prototype.bind_event_handler=function(){return this.debug("TemporaryIdentifierWidget::bind_event_handler"),e("body").on("change",".TemporaryIdentifier input[type='checkbox']",this.on_temporary_change),e("body").on("change",".TemporaryIdentifier input[type='text']",this.on_value_change)},t.prototype.on_temporary_change=function(t){var r,i,n,a,u;return this.debug("°°° TemporaryIdentifierWidget::on_temporary_change °°°"),i=t.currentTarget,n=this.get_field_name(i),u=i.checked,this.set_temporary(n,u),r=this.get_autogenerated_id(n,this.auto_wildcard),(a=this.get_input_element(n)).disabled=u,u&&!a.value?(a.value=r,e(a).trigger("change")):u||a.value!==r?void 0:(a.value="",e(a).trigger("change"))},t.prototype.on_value_change=function(e){var t,r,i;if(this.debug("°°° TemporaryIdentifierWidget::on_value_change °°°"),r=e.currentTarget,i=this.get_field_name(r),t=this.get_current_id(i),this.set_current_id(i,r.value),r.value&&r.value!==this.auto_wildcard)return this.search_mrn(r.value).done((function(e){var n,a;if(e)return a=this,null==e.identifier&&(e.identifier=r.value),(n=this.template_dialog("existing-identifier",e)).on("yes",(function(){var t,n;for(i in t=[],e)n=e[i],"DateOfBirth"===i&&(n=a.format_date(n)),t.push(a.set_sibling_value(r,i,n));return t})),n.on("no",(function(){return r.value=t,a.set_current_id(i,t)}))}))},t.prototype.set_temporary=function(e,t){return this.get_subfield(e,"temporary").value=t||""},t.prototype.set_current_id=function(e,t){return this.get_subfield(e,"value").value=t},t.prototype.get_current_id=function(e,t){return null==t&&(t=""),this.get_subfield(e,"value").value||t},t.prototype.get_autogenerated_id=function(e,t){return null==t&&(t=""),this.get_subfield(e,"value_auto").value||t},t.prototype.get_input_element=function(e){return document.querySelector("#"+e+"_value")},t.prototype.get_field_name=function(t){var r;return r=t.closest("div[data-fieldname]"),e(r).attr("data-fieldname")},t.prototype.get_sibling=function(t,r){var i,n;return i=r,this.is_add_sample_form&&(n=t.closest("td[arnum]"),i=r+"-"+e(n).attr("arnum")),document.querySelector('[name="'+i+'"]')},t.prototype.set_sibling_value=function(e,t,r){var i;if(this.debug("°°° TemporaryIdentifierWidget::set_sibling_value:name="+t+",value="+r+" °°°"),i=this.get_sibling(e,t))return this.debug(">>> "+i.name+" = "+r+" "),i.value=r},t.prototype.format_date=function(e){var t;return null==e?"":[(t=new Date(e)).getFullYear(),("0"+(t.getMonth()+1)).slice(-2),("0"+t.getDate()).slice(-2)].join("-")},t.prototype.get_subfield=function(e,t){return document.querySelector('input[name^="'+e+"."+t+':"]')},t.prototype.search_mrn=function(t){var r,i,n;return this.debug("°°° TemporaryIdentifierWidget::search_mrn:mrn="+t+" °°°"),i=["PatientFullName","PatientAddress","DateOfBirth","Age","Sex"],r=e.Deferred(),n={url:this.get_portal_url()+"/@@API/read",data:{catalog_name:"bika_catalog_analysisrequest_listing",medical_record_number:t,include_fields:i,page_size:1}},this.ajax_submit(n).done((function(e){var t;return t={},e.objects&&(t=e.objects[0]),r.resolveWith(this,[t])})),r.promise()},t.prototype.template_dialog=function(t,r,i){var n;return null==i&&((i={})[_t("Yes")]=function(){return e(this).trigger("yes"),e(this).dialog("close")},i[_t("No")]=function(){return e(this).trigger("no"),e(this).dialog("close")}),n=this.render_template(t,r),e(n).dialog({width:450,resizable:!1,closeOnEscape:!1,buttons:i,open:function(t,r){return e(".ui-dialog-titlebar-close").hide()}})},t.prototype.render_template=function(t,r){var i;if(this.debug("°°° TemporaryIdentifierWidget::render_template:template_id:"+t+" °°°"),i=e("#"+t).html())return Handlebars.compile(i)(r)},t.prototype.ajax_submit=function(t){var r;return null==t&&(t={}),this.debug("°°° TemporaryIdentifierWidget::ajax_submit °°°"),null==t.type&&(t.type="POST"),null==t.url&&(t.url=this.get_portal_url()),null==t.context&&(t.context=this),null==t.dataType&&(t.dataType="json"),null==t.data&&(t.data={}),null==t._authenticator&&(t._authenticator=e("input[name='_authenticator']").val()),console.debug(">>> ajax_submit::options=",t),e(this).trigger("ajax:submit:start"),r=function(){return e(this).trigger("ajax:submit:end")},e.ajax(t).done(r)},t.prototype.get_portal_url=function(){return e("input[name=portal_url]").val()||window.portal_url},t.prototype.debug=function(e){return console.debug("[senaite.patient.temporary_identifier_widget] ",e)},t}(),t.a=r}).call(this,r(3))},function(e,t,r){e.exports=r(2)},function(e,t,r){"use strict";r.r(t);var i=r(0);document.addEventListener("DOMContentLoaded",(function(){console.debug("*** SENAITE PATIENT JS LOADED ***"),window.temporary_identifier_widget=new i.a}))},function(e,t){e.exports=jQuery}]);