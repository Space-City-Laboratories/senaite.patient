!function(e){var t={};function i(n){if(t[n])return t[n].exports;var r=t[n]={i:n,l:!1,exports:{}};return e[n].call(r.exports,r,r.exports,i),r.l=!0,r.exports}i.m=e,i.c=t,i.d=function(e,t,n){i.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},i.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},i.t=function(e,t){if(1&t&&(e=i(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(i.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var r in e)i.d(n,r,function(t){return e[t]}.bind(null,r));return n},i.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return i.d(t,"a",t),t},i.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},i.p="/++plone++senaite.patient.static/bundles",i(i.s=1)}([function(e,t){e.exports=jQuery},function(e,t,i){e.exports=i(2)},function(e,t,i){"use strict";i.r(t);var n=i(0),r=i.n(n);function a(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}var u=function(){function e(){return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.reset_values=this.reset_values.bind(this),this.reset_value=this.reset_value.bind(this),this.bind_event_handler=this.bind_event_handler.bind(this),this.on_temporary_change=this.on_temporary_change.bind(this),this.on_value_change=this.on_value_change.bind(this),this.on_keypress=this.on_keypress.bind(this),this.set_temporary=this.set_temporary.bind(this),this.set_current_id=this.set_current_id.bind(this),this.get_current_id=this.get_current_id.bind(this),this.get_autogenerated_id=this.get_autogenerated_id.bind(this),this.get_input_element=this.get_input_element.bind(this),this.get_field_name=this.get_field_name.bind(this),this.get_sibling=this.get_sibling.bind(this),this.set_sibling_value=this.set_sibling_value.bind(this),this.format_date=this.format_date.bind(this),this.get_subfield=this.get_subfield.bind(this),this.search_mrn=this.search_mrn.bind(this),this.template_dialog=this.template_dialog.bind(this),this.render_template=this.render_template.bind(this),this.ajax_submit=this.ajax_submit.bind(this),this.get_portal_url=this.get_portal_url.bind(this),this.debug=this.debug.bind(this),console.debug("TemporaryIdentifierWidget::load"),this.auto_wildcard="-- autogenerated --",this.is_add_sample_form=document.body.classList.contains("template-ar_add"),this.is_add_sample_form&&this.reset_values(),this.bind_event_handler(),this}var t,i,n;return t=e,(i=[{key:"reset_values",value:function(){var e,t,i,n,r,a,u,s,o,l,d,_;for(this.debug("°°° TemporaryIdentifierWidget::reset_values"),_=".TemporaryIdentifier.temporary-id input[id$='_value']",t=0,r=(s=document.querySelectorAll(_)).length;t<r;t++)e=s[t],this.reset_value(e,this.auto_wildcard);for(_=".TemporaryIdentifier.temporary-id input[name*='.value:']",i=0,a=(o=document.querySelectorAll(_)).length;i<a;i++)e=o[i],this.reset_value(e,this.auto_wildcard);for(_=".TemporaryIdentifier input[name*='.value_auto:']",d=[],n=0,u=(l=document.querySelectorAll(_)).length;n<u;n++)e=l[n],d.push(this.reset_value(e));return d}},{key:"reset_value",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"";return this.debug("°°° TemporaryIdentifierWidget::reset_value:el=".concat(e.id||e.name,",value='").concat(t,"'")),e.value=t}},{key:"bind_event_handler",value:function(){return this.debug("TemporaryIdentifierWidget::bind_event_handler"),r()("body").on("change",".TemporaryIdentifier input[type='checkbox']",this.on_temporary_change),r()("body").on("change",".TemporaryIdentifier input[type='text']",this.on_value_change),r()("body").on("keypress",".TemporaryIdentifier input[type='text']",this.on_keypress)}},{key:"on_temporary_change",value:function(e){var t,i,n,a,u;return this.debug("°°° TemporaryIdentifierWidget::on_temporary_change °°°"),i=e.currentTarget,n=this.get_field_name(i),u=i.checked,this.set_temporary(n,u),t=this.get_autogenerated_id(n,this.auto_wildcard),(a=this.get_input_element(n)).disabled=u,u&&!a.value?(a.value=t,r()(a).trigger("change")):u||a.value!==t?void 0:(a.value="",r()(a).trigger("change"))}},{key:"on_value_change",value:function(e){var t,i,n,a;if(this.debug("°°° TemporaryIdentifierWidget::on_value_change °°°"),n=e.currentTarget,a=this.get_field_name(n),i=this.get_current_id(a),this.set_current_id(a,n.value),n.value&&n.value!==this.auto_wildcard)return t=this.get_sibling(n,"config_catalog").value,this.search_mrn(n.value,t).done((function(e){var t,u,s,o,l,d;if(e)return t=[e.address,e.zipcode,e.city,e.country].filter((function(e){return e})),l={PatientFullName:e.Title,PatientAddress:t.join(", "),DateOfBirth:this.format_date(e.birthdate),Age:e.age,Gender:e.gender,review_state:e.review_state},d="existing-identifier",u=null,"inactive"===e.review_state&&(d="inactive-patient",(u={})[_t("Close")]=function(){return r()(this).trigger("no"),r()(this).dialog("close")}),o=this,null==e.identifier&&(e.identifier=n.value),(s=this.template_dialog(d,e,u)).on("yes",(function(){var e,t;for(a in e=[],l)t=l[a],e.push(o.set_sibling_value(n,a,t));return e})),s.on("no",(function(){return n.value=i,o.set_current_id(a,i)}))}))}},{key:"on_keypress",value:function(e){var t;if(13===e.keyCode)return t=e.currentTarget,r()(t).trigger("blur"),e.preventDefault()}},{key:"set_temporary",value:function(e,t){return this.get_subfield(e,"temporary").value=t||""}},{key:"set_current_id",value:function(e,t){return this.get_subfield(e,"value").value=t}},{key:"get_current_id",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"";return this.get_subfield(e,"value").value||t}},{key:"get_autogenerated_id",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"";return this.get_subfield(e,"value_auto").value||t}},{key:"get_input_element",value:function(e){return document.querySelector("#".concat(e,"_value"))}},{key:"get_field_name",value:function(e){var t;return t=e.closest("div[data-fieldname]"),r()(t).attr("data-fieldname")}},{key:"get_sibling",value:function(e,t){var i;return i=t,document.querySelector('[name="'+i+'"]')}},{key:"set_sibling_value",value:function(e,t,i){var n;if(this.debug("°°° TemporaryIdentifierWidget::set_sibling_value:name=".concat(t,",value=").concat(i," °°°")),n=this.get_sibling(e,t))return this.debug(">>> ".concat(n.name," = ").concat(i," ")),n.value=i}},{key:"format_date",value:function(e){var t;return null==e?"":[(t=new Date(e)).getFullYear(),("0"+(t.getMonth()+1)).slice(-2),("0"+t.getDate()).slice(-2)].join("-")}},{key:"get_subfield",value:function(e,t){return document.querySelector('input[name^="'+e+"."+t+':"]')}},{key:"search_mrn",value:function(e,t){var i,n,a;return this.debug("°°° TemporaryIdentifierWidget::search_mrn:mrn=".concat(e," °°°")),n=["Title","name","surname","age","birthdate","gender","email","address","zipcode","city","country","review_state"],i=r.a.Deferred(),a={url:this.get_portal_url()+"/@@API/read",data:{portal_type:"Patient",catalog_name:t,patient_mrn:e,include_fields:n,page_size:1}},this.ajax_submit(a).done((function(e){var t;return t={},e.objects&&(t=e.objects[0]),i.resolveWith(this,[t])})),i.promise()}},{key:"template_dialog",value:function(e,t,i){var n;return null==i&&((i={})[_t("Yes")]=function(){return r()(this).trigger("yes"),r()(this).dialog("close")},i[_t("No")]=function(){return r()(this).trigger("no"),r()(this).dialog("close")}),n=this.render_template(e,t),r()(n).dialog({width:450,resizable:!1,closeOnEscape:!1,buttons:i,open:function(e,t){return r()(".ui-dialog-titlebar-close").hide()}})}},{key:"render_template",value:function(e,t){var i;if(this.debug("°°° TemporaryIdentifierWidget::render_template:template_id:".concat(e," °°°")),i=r()("#".concat(e)).html())return Handlebars.compile(i)(t)}},{key:"ajax_submit",value:function(){var e,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return this.debug("°°° TemporaryIdentifierWidget::ajax_submit °°°"),null==t.type&&(t.type="POST"),null==t.url&&(t.url=this.get_portal_url()),null==t.context&&(t.context=this),null==t.dataType&&(t.dataType="json"),null==t.data&&(t.data={}),null==t._authenticator&&(t._authenticator=r()("input[name='_authenticator']").val()),console.debug(">>> ajax_submit::options=",t),r()(this).trigger("ajax:submit:start"),e=function(){return r()(this).trigger("ajax:submit:end")},r.a.ajax(t).done(e)}},{key:"get_portal_url",value:function(){return r()("input[name=portal_url]").val()||window.portal_url}},{key:"debug",value:function(e){return console.debug("[senaite.patient.temporary_identifier_widget] ",e)}}])&&a(t.prototype,i),n&&a(t,n),e}();document.addEventListener("DOMContentLoaded",(function(){console.debug("*** SENAITE PATIENT JS LOADED ***"),window.temporary_identifier_widget=new u}))}]);